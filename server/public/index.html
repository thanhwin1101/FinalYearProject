<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>RFID Button Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:system-ui,Arial;padding:20px;max-width:900px;margin:auto}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    select,input,button{padding:8px}
    canvas{max-width:100%; height:380px}
  </style>
</head>
<body>
  <h2>RFID Button Press – Dashboard</h2>

  <div class="row">
    <label>Người dùng:</label>
    <select id="userSelect"></select>
    <label>Từ ngày:</label>
    <input type="date" id="fromDate"/>
    <label>Đến ngày:</label>
    <input type="date" id="toDate"/>
    <button id="loadBtn">Tải dữ liệu</button>
  </div>

  <canvas id="chart"></canvas>

<script>
  const API = location.origin;
  const userSelect = document.getElementById('userSelect');
  const fromDate = document.getElementById('fromDate');
  const toDate = document.getElementById('toDate');
  const loadBtn = document.getElementById('loadBtn');
  let chart, usersCache = [];

  async function loadUsers() {
    const res = await fetch(`${API}/api/users`);
    const users = await res.json();
    usersCache = users; // lưu để map uid -> name
    userSelect.innerHTML = `<option value="">-- Tất cả --</option>` +
      users.map(u => `<option value="${u.uid}">${u.name} (${u.uid})</option>`).join('');
  }

  function nameOf(uid) {
    const u = usersCache.find(x => x.uid === uid);
    return u ? `${u.name}` : uid;
  }

  async function loadStats() {
    const params = new URLSearchParams();
    if (fromDate.value) params.set('from', fromDate.value);
    if (toDate.value) params.set('to', toDate.value);

    // Nếu chọn 1 user -> gọi API cũ (theo ngày)
    if (userSelect.value) {
      params.set('uid', userSelect.value);
      const res = await fetch(`${API}/api/events/stats/daily?` + params.toString());
      const data = await res.json(); // [{_id:'YYYY-MM-DD', count:n}, ...]
      drawSingleUser(data, nameOf(userSelect.value));
      return;
    }

    // Nếu chọn "Tất cả" -> gọi API mới (ngày + uid)
    const res = await fetch(`${API}/api/events/stats/daily-by-user?` + params.toString());
    const raw = await res.json(); // [{_id:{day, uid}, count}, ...]

    // labels = danh sách ngày
    const labels = Array.from(new Set(raw.map(r => r._id.day))).sort();
    // danh sách uid
    const uids = Array.from(new Set(raw.map(r => r._id.uid))).sort();

    // build dataset cho từng uid
    const datasets = uids.map(uid => {
      const map = new Map(raw.filter(r => r._id.uid === uid).map(r => [r._id.day, r.count]));
      const arr = labels.map(day => map.get(day) || 0);
      return {
        label: nameOf(uid) + ` (${uid})`,
        data: arr,
        // để Chart.js tự màu; không set color theo yêu cầu mặc định
        stack: 'users'
      };
    });

    if (chart) chart.destroy();
    const ctx = document.getElementById('chart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets },
      options: {
        responsive: true,
        scales: {
          x: { stacked: true },
          y: { stacked: true, beginAtZero: true, ticks: { precision: 0 } }
        },
        plugins: { legend: { position: 'top' } }
      }
    });
  }

  function drawSingleUser(data, label) {
    const labels = data.map(d => d._id);
    const values = data.map(d => d.count);
    if (chart) chart.destroy();
    const ctx = document.getElementById('chart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{ label: `Số lần bấm – ${label}`, data: values }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
      }
    });
  }

  // default 7 ngày gần nhất
  const now = new Date();
  const past = new Date(now.getTime() - 6*24*3600*1000);
  fromDate.valueAsDate = past;
  toDate.valueAsDate = now;

  loadUsers().then(loadStats);
  loadBtn.addEventListener('click', loadStats);
  userSelect.addEventListener('change', loadStats); // đổi user là vẽ lại
</script>

</body>
</html>
